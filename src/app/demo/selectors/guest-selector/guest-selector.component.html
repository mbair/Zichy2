<!-- Selected guests as chips above the selector -->
<div class="flex flex-wrap gap-2 mb-2" *ngIf="selectedGuests?.length">
    <p-chip
        *ngFor="let g of selectedGuests; trackBy: trackByGuestId"
        [label]="g.lastName + ' ' + g.firstName"
        icon="pi pi-user"
        [removable]="true"
        [styleClass]="'cursor-pointer color-badge ' + getColorByRoomType(g?.roomType || '')"
        pTooltip="{{ g.roomMate }}"
        tooltipPosition="top"
        (onRemove)="removeGuest(g)">
    </p-chip>
</div>

<p-multiSelect
    #guestSelector
    class="multiselect-custom-virtual-scroll"
    panelStyleClass="guest-multiselect-panel"
    dataKey="id"
    [options]="groupByRoomMate ? groupedGuests : guests"
    [group]="groupByRoomMate"
    [(ngModel)]="selectedGuests"
    (onChange)="onSelectionChange($event)"
    (onClear)="onSelectionClear()"
    [disabled]="disabled"
    optionLabel="fullName"
    optionDisabled="disabled"
    optionGroupChildren="items"
    filterBy="lastName,firstName,roomMate"
    [selectionLimit]="selectionLimit"
    [placeholder]="placeholder"
    emptyMessage="{{ 'Nincs találat...' | translate }}"
    [virtualScroll]="!groupByRoomMate"
    [virtualScrollItemSize]="groupByRoomMate ? 0 : 65"
    [showClear]="showClear"
    [style]="style"
    styleClass="height:53px"
    scrollHeight="400px"
    appendTo="body"
    display="chip">

    <ng-template let-group pTemplate="group">
        <div class="flex align-items-center px-1 cursor-pointer bg-surface-100"
            (click)="toggleGroupSelection(group, $event)">

            <i class="pi mr-2"
            [ngClass]="{
                'pi-check-square': isGroupFullySelected(group),
                'pi-minus-square': isGroupPartiallySelected(group),
                'pi-square': !isGroupFullySelected(group) && !isGroupPartiallySelected(group)
            }"
            style="font-size: 1.3rem"></i>

            <span class="font-semibold">{{ group.label }}</span>
            <span class="ml-2 text-xs text-500">({{ group.items.length }} fő)</span>
        </div>
    </ng-template>

    <ng-template pTemplate="item" let-option>
        <div class="building-badge {{getColorByRoomType(option.roomType)}} border-round-xl w-min p-0">
            <div class="flex align-items-center justify-content-center py-1 px-1">
                <div class="block min-w-max border-left-1 px-2" pTooltip="Szoba kód: {{ option.roomCode }}" tooltipPosition="top">
                    <div class="flex flex-column align-items-left justify-content-center">
                        <span class="text-base font-semibold uppercase">
                            {{ option.lastName }} {{ option.firstName }}
                            <span class="font-normal text-sm uppercase">({{ getAge(option.birthDate) }})</span>
                            <span *ngIf="option.climate" class="pl-1">❄️</span>
                        </span>
                        <span class="font-light text-xs uppercase">
                            {{ option.beds }} SZEMÉLYES ({{ option.bedType }}<span *ngIf="option.bathroom">, {{ option.bathroom }}</span>)
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </ng-template>
  
    <ng-template pTemplate="selectedItem" let-selectedItem>
        <div class="color-badge {{ getColorByRoomType(selectedItem.roomType) }} border-round-xl w-min p-0">
            <div class="flex align-items-center justify-content-center py-1 px-1">
                <div class="block min-w-max" pTooltip="{{ selectedItem.roomMate }}" tooltipPosition="top">
                    <div class="flex flex-column align-items-left justify-content-center">
                        <span class="text-base font-semibold uppercase">
                            {{ selectedItem.lastName }} {{ selectedItem.firstName }}
                            <span class="font-normal text-sm uppercase">({{ getAge(selectedItem.birthDate) }})</span>
                        </span>
                        <span class="font-light text-xs uppercase">
                            {{ selectedItem.roomType }}
                        </span>
                        <div class="font-light text-xs white-space-nowrap overflow-hidden text-overflow-ellipsis max-w-30rem">
                            {{ selectedItem.roomMate }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </ng-template>
</p-multiSelect>
<div class="grid">
    <div class="col-12">
        <div class="card px-0 py-0">
            <p-table #dt dataKey="id" [value]="tableData" responsiveLayout="scroll" [rows]="rowsPerPage"
                [totalRecords]="totalRecords" [globalFilterFields]="['name', 'beginDate', 'endDate']" [paginator]="true"
                [rowsPerPageOptions]="rowsPerPageOptions" [showCurrentPageReport]="true"
                currentPageReportTemplate="{first} - {last} bejegyzés a(z) {totalRecords}-ból megjelenítése"
                [(selection)]="selected" selectionMode="multiple" [tableStyle]="{'min-height': 'calc(100vh - 320px)'}"
                [rowHover]="true" (onLazyLoad)="onLazyLoad($event)" [lazy]="true">

                <ng-template pTemplate="caption">
                    <div class="flex flex-column md:flex-row md:justify-content-between md:align-items-center">
                        <h5 class="m-0">Konferenciák</h5>
                        <span class="block mt-2 md:mt-0 p-input-icon-left">
                            <i class="pi pi-search"></i>
                            <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Keresés..."
                                class="w-full sm:w-auto" />
                        </span>
                        <span class="block mt-2 md:mt-0">
                            <!-- Open new page -->
                            <!-- <a routerLink="/conference/create" class="p-button p-button-success p-ripple font-normal mr-2 hover:bg-green-600 hover:border-green-600">
                                <i class="pi pi-plus x mr-2"></i> Új
                            </a> -->
                            <button pButton pRipple label="Új" icon="pi pi-plus" class="p-button-success mr-2"
                                (click)="create()"
                                [disabled]="!userService.hasRole(['Super Admin','Nagy Admin'])"></button>
                            <button pButton pRipple label="Törlés" icon="pi pi-trash" class="p-button-danger mr-2"
                                (click)="bulkDeleteDialog = true"
                                [disabled]="!selected || !selected.length || !userService.hasRole(['Super Admin','Nagy Admin'])"></button>
                        </span>
                    </div>
                </ng-template>
                <ng-template pTemplate="header">
                    <tr>
                        <th></th>
                        <th pSortableColumn="name">Név <p-sortIcon field="name"></p-sortIcon></th>
                        <th pSortableColumn="beginDate">Kezdete <p-sortIcon field="beginDate"></p-sortIcon></th>
                        <th pSortableColumn="firstMeal">Első étkezés <p-sortIcon field="beginDate"></p-sortIcon></th>
                        <th pSortableColumn="endDate">Vége <p-sortIcon field="endDate"></p-sortIcon></th>
                        <th pSortableColumn="lastMeal">Utolsó étkezés <p-sortIcon field="endDate"></p-sortIcon></th>
                        <!-- <th pSortableColumn="guestsNumber">Létszám <p-sortIcon field="guestsNumber"></p-sortIcon></th> -->
                        <th></th>
                    </tr>
                    <tr>
                        <th style="width: 3rem">
                            <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                        </th>
                        <th>
                            <input pInputText type="text" (input)="onFilter($event, 'name')" placeholder="Keresés..."
                                style="width:40%; min-width:22rem;" />
                        </th>
                        <th>
                            <p-calendar (onSelect)="onFilter($event, 'beginDate')"
                                (onClearClick)="onFilter($event, 'beginDate')" appendTo="body" dataType="string"
                                placeholder="Keresés..." [showButtonBar]="true">
                            </p-calendar>
                        </th>
                        <th>
                            <p-dropdown inputId="firstMealFilter" [options]="meals" [showClear]="true"
                                placeholder="Keresés..." (onChange)="onFilter($event, 'firstMeal')">
                            </p-dropdown>
                        </th>
                        <th>
                            <p-calendar (onSelect)="onFilter($event, 'endDate')"
                                (onClearClick)="onFilter($event, 'endDate')" appendTo="body" dataType="string"
                                placeholder="Keresés..." [showButtonBar]="true">
                            </p-calendar>
                        </th>
                        <th>
                            <p-dropdown inputId="lastMealFilter" [options]="meals" [showClear]="true"
                                placeholder="Keresés..." (onChange)="onFilter($event, 'lastMeal')">
                            </p-dropdown>
                        </th>
                        <!-- <th></th> -->
                        <th></th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-conference>
                    <tr>
                        <td>
                            <p-tableCheckbox [value]="conference"></p-tableCheckbox>
                        </td>
                        <td style="width:30%; min-width:15rem;">
                            <span class="p-column-title">Név</span>
                            {{conference.name}}
                        </td>
                        <td style="width:14%; min-width:10rem;">
                            <span class="p-column-title">Kezdete</span>
                            {{conference.beginDate | date:'yyyy.MM.dd'}}
                        </td>
                        <td style="width:14%; min-width:10rem;">
                            <span class="p-column-title">Első étkezés</span>
                            {{conference.firstMeal}}
                        </td>
                        <td style="width:14%; min-width:10rem;">
                            <span class="p-column-title">Vége</span>
                            {{conference.endDate | date:'yyyy.MM.dd'}}
                        </td>
                        <td style="width:14%; min-width:10rem;">
                            <span class="p-column-title">Utolsó étkezés</span>
                            {{conference.lastMeal}}
                        </td>
                        <!-- <td style="width:14%; min-width:10rem;">
                            <span class="p-column-title">Létszám</span>
                            {{conference.attendees}}
                        </td> -->
                        <td>
                            <div class="flex">
                                <button pButton pRipple icon="pi pi-copy" class="p-button-rounded p-button-success mr-2"
                                    pTooltip="Regisztrációs link másolása vágólapra" tooltipPosition="top"
                                    (click)="copyUrl(conference.formUrl)" [disabled]="!conference.formUrl">
                                </button>
                                <button pButton pRipple icon="pi pi-search"
                                    class="p-button-rounded p-button-success mr-2"
                                    pTooltip="Regisztrációs űrlap megnyitása" tooltipPosition="top"
                                    (click)="navigateToConferenceForm(conference)">
                                </button>
                                <button pButton pRipple icon="pi pi-question"
                                    class="p-button-rounded p-button-success mr-2" pTooltip="Extra kérdések beállítása"
                                    tooltipPosition="top" (click)="editQuestions(conference)">
                                </button>
                                <button pButton pRipple icon="pi pi-pencil"
                                    class="p-button-rounded p-button-success mr-2" pTooltip="Konferencia szerkesztése"
                                    tooltipPosition="top" (click)="edit(conference)"
                                    [disabled]="!userService.hasRole(['Super Admin','Nagy Admin'])">
                                </button>
                                <button pButton pRipple icon="pi pi-trash" class="p-button-rounded p-button-warning"
                                    pTooltip="Konferencia törlése" tooltipPosition="top"
                                    (click)="tableItem = conference; deleteDialog = true"
                                    [disabled]="!userService.hasRole(['Super Admin','Nagy Admin'])">
                                </button>
                            </div>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td [attr.colspan]="7" class="text-center">Nincs találat...</td>
                    </tr>
                </ng-template>
            </p-table>
        </div>

        <!-- Sidebar -->
        <p-sidebar id="sidebar" [(visible)]="sidebar" position="right" styleClass="p-sidebar-md">

            <!-- Sidebar header -->
            <ng-template pTemplate="header">
                <span class="font-semibold text-xl">Konferencia adatai</span>
            </ng-template>

            <form [formGroup]="conferenceForm" (ngSubmit)="save()" novalidate class="grid formgrid p-fluid">

                <!-- Konferencia Id -->
                <input formControlName="id" type="hidden">

                <!-- Konferencia neve -->
                <div class="field mb-4 col-12">
                    <label for="name" class="font-medium text-900">Konferencia neve</label>
                    <input id="name" type="text" pInputText formControlName="name">
                    <div *ngIf="name?.dirty && name?.errors?.['required']" class="block p-error">Kötelező kitölteni
                    </div>
                </div>

                <!-- Űrlap URL -->
                <div class="field mb-4 col-12">
                    <label for="formUrl" class="font-medium text-900">Regisztrációs űrlap link</label>
                    <span class="block mt-2 md:mt-0 p-input-icon-right">
                        <i class="pi pi-copy cursor-pointer hover:text-blue-500" (click)="copyUrl(formUrl?.value)"></i>
                        <input id="formUrl" type="text" pInputText formControlName="formUrl" readonly>
                    </span>
                    <div *ngIf="formUrl?.dirty && formUrl?.errors?.['required']" class="block p-error">Kötelező
                        kitölteni</div>
                </div>

                <!-- Kezdete -->
                <div class="field mb-4 col-12 lg:col-6">
                    <label for="beginDate" class="font-medium text-900">Kezdete</label>
                    <p-calendar formControlName="beginDate" appendTo="body" dataType="string" dateFormat="yy-mm-dd"
                        [showButtonBar]="true">
                    </p-calendar>
                    <div *ngIf="beginDate?.dirty && beginDate?.errors?.['required']" class="block p-error">Kötelező
                        kitölteni</div>
                </div>

                <!-- Első étkezés -->
                <div class="field mb-4 col-12 lg:col-6">
                    <label for="firstMeal" class="font-medium text-900">Első étkezés</label>
                    <p-dropdown id="firstMealFilter" formControlName="firstMeal" [options]="meals"
                        placeholder="Válassz...">
                    </p-dropdown>
                    <div *ngIf="firstMeal?.dirty && firstMeal?.errors?.['required']" class="block p-error">Kötelező
                        kitölteni</div>
                </div>

                <!-- Vége -->
                <div class="field mb-4 col-12 lg:col-6">
                    <label for="endDate" class="font-medium text-900">Vége</label>
                    <p-calendar formControlName="endDate" appendTo="body" dataType="string" dateFormat="yy-mm-dd"
                        [showButtonBar]="true">
                    </p-calendar>
                    <div *ngIf="endDate?.dirty && endDate?.errors?.['required']" class="block p-error">Kötelező
                        kitölteni</div>
                </div>

                <!-- Utolsó étkezés -->
                <div class="field mb-4 col-12 lg:col-6">
                    <label for="lastMeal" class="font-medium text-900">Utolsó étkezés</label>
                    <p-dropdown id="lastMealFilter" formControlName="lastMeal" [options]="meals"
                        placeholder="Válassz...">
                    </p-dropdown>
                    <div *ngIf="lastMeal?.dirty && lastMeal?.errors?.['required']" class="block p-error">Kötelező
                        kitölteni</div>
                </div>

                <!-- Szerződő neve -->
                <div class="field mb-4 col-12 lg:col-6">
                    <label for="contractorName" class="font-medium text-900">Szerződő neve</label>
                    <input id="contractorName" type="text" pInputText formControlName="contractorName">
                    <div *ngIf="contractorName?.dirty && contractorName?.errors?.['required']" class="block p-error">
                        Kötelező kitölteni</div>
                </div>

                <!-- Szerződő adószáma -->
                <div class="field mb-4 col-12 lg:col-6">
                    <label for="contractorTaxNumber" class="font-medium text-900">Szerződő adószáma</label>
                    <input id="contractorTaxNumber" type="text" pInputText formControlName="contractorTaxNumber">
                    <div *ngIf="contractorTaxNumber?.dirty && contractorTaxNumber?.errors?.['required']"
                        class="block p-error">Kötelező kitölteni</div>
                </div>

                <!-- Szerződő címe -->
                <div class="field mb-4 col-12">
                    <label for="contractorAdress" class="font-medium text-900">Szerződő címe</label>
                    <input id="contractorAdress" type="text" pInputText formControlName="contractorAdress">
                    <div *ngIf="contractorAdress?.dirty && contractorAdress?.errors?.['required']"
                        class="block p-error">Kötelező kitölteni</div>
                </div>

                <!-- Kapcsolattartó neve -->
                <div class="field mb-4 col-12 lg:col-6">
                    <label for="contactName" class="font-medium text-900">Kapcsolattartó neve</label>
                    <input id="contactName" type="text" pInputText formControlName="contactName">
                    <div *ngIf="contactName?.dirty && contactName?.errors?.['required']" class="block p-error">Kötelező
                        kitölteni</div>
                </div>

                <!-- Kapcsolattartó telefon -->
                <div class="field mb-4 col-12 lg:col-6">
                    <label for="contactPhone" class="font-medium text-900">Kapcsolattartó telefonszáma</label>
                    <input id="contactPhone" type="text" pInputText formControlName="contactPhone">
                    <div *ngIf="contactPhone?.dirty && contactPhone?.errors?.['required']" class="block p-error">
                        Kötelező kitölteni</div>
                </div>

                <!-- Kapcsolattartó e-mail -->
                <div class="field mb-4 col-12 lg:col-6">
                    <label for="contactEmail" class="font-medium text-900">Kapcsolattartó e-mail címe</label>
                    <input id="contactEmail" type="text" pInputText formControlName="contactEmail">
                    <div *ngIf="contactEmail?.dirty && contactEmail?.errors?.['required']" class="block p-error">
                        Kötelező kitölteni</div>
                    <div *ngIf="contactEmail?.dirty && contactEmail?.errors?.['invalidEmail']" class="block p-error">Nem
                        megfelelő email formátum</div>
                </div>

                <!-- Regisztráció vége -->
                <div class="field mb-4 col-12 lg:col-6">
                    <label for="registrationEndDate" class="font-medium text-900">Regisztráció vége</label>
                    <p-calendar formControlName="registrationEndDate" appendTo="body" dataType="string"
                        dateFormat="yy-mm-dd" [showButtonBar]="true">
                    </p-calendar>
                    <div *ngIf="registrationEndDate?.dirty && registrationEndDate?.errors?.['required']"
                        class="block p-error">Kötelező kitölteni</div>
                </div>
            </form>
            <ng-template pTemplate="footer">
                <div class="flex justify-content-end ap-2">
                    <button pButton pRipple label="Mégsem" icon="pi pi-times" class="p-button-outlined"
                        (click)="cancel()" [disabled]="!conferenceForm.dirty"></button>
                    <button pButton pRipple label="Mentés" icon="pi pi-check" class="p-button ml-2" (click)="save()"
                        [disabled]="!conferenceForm.valid || !conferenceForm.dirty"></button>
                </div>
            </ng-template>
        </p-sidebar>

        <!-- Questions sidebar -->
        <p-sidebar id="questionsSidebar" [(visible)]="questionsSidebar" position="right" styleClass="p-sidebar-md">

            <!-- Sidebar header -->
            <ng-template pTemplate="header">
                <span class="font-semibold text-xl">Szerverző kérdései</span>
            </ng-template>

            <p class="block text-sm mb-0">
                Űrlaponként az alapértelmezett mezőkön felül 5 extra kérdés tehető fel.<br>
                Az üresen hagyott kérdések nem fognak megjelenni az űrlapon.
            </p>

            <form [formGroup]="questionsForm" (ngSubmit)="saveQuestions()" novalidate class="p-fluid">

                <!-- Konferencia Id -->
                <input formControlName="conferenceId" type="hidden">

                <!-- Kérdések -->
                <div formArrayName="questions" class="flex flex-wrap w-full">
                    <div *ngFor="let question of questions.controls; let i = index" [formGroupName]="i" class="w-full mt-3">
                        <label for="en-{{i}}" class="font-medium text-900 mb-2">
                            {{ i+1 }}. kérdés
                        </label>

                        <!-- Magyar kérdés input mező -->
                        <div class="block mt-2 p-input-icon-left">
                            <i>
                                <img src="assets/demo/images/flag/flag_placeholder.png" class="flag flag-hu"
                                    style="width: 18px; margin-top:-8px" />
                            </i>
                            <input id="hu-{{i}}" type="text" pInputText formControlName="hu" class="w-full" />
                        </div>

                        <!-- Angol kérdés input mező -->
                        <div class="block mt-2 p-input-icon-left">
                            <i>
                                <img src="assets/demo/images/flag/flag_placeholder.png" class="flag flag-gb"
                                    style="width: 18px; margin-top:-8px" />
                            </i>
                            <input id="en-{{i}}" type="text" pInputText formControlName="en" class="w-full" />
                        </div>
                    </div>
                </div>
            </form>
            <ng-template pTemplate="footer">
                <div class="flex justify-content-end ap-2">
                    <button pButton pRipple label="Mégsem" icon="pi pi-times" class="p-button-outlined"
                        (click)="cancelQuestions()" [disabled]="!questionsForm.dirty"></button>
                    <button pButton pRipple label="Mentés" icon="pi pi-check" class="p-button ml-2"
                        (click)="saveQuestions()" [disabled]="!questionsForm.valid || !questionsForm.dirty"></button>
                </div>
            </ng-template>
        </p-sidebar>

        <!-- Delete dialog -->
        <p-dialog [(visible)]="deleteDialog" header="Törlés" [modal]="true" [style]="{width:'450px'}">
            <div class="flex align-items-center justify-content-center">
                <i class="pi pi-exclamation-triangle mr-3" style="font-size: 2rem"></i>
                <span *ngIf="tableItem">Biztosan törölni akarja a(z) <b>{{tableItem.name}}</b> konferenciát?</span>
            </div>
            <ng-template pTemplate="footer">
                <div class="flex justify-content-end ap-2">
                    <button pButton pRipple label="Nem" icon="pi pi-times" class="p-button-outlined"
                        (click)="deleteDialog = false"></button>
                    <button pButton pRipple label="Igen" icon="pi pi-check" class="p-button ml-2"
                        (click)="delete()"></button>
                </div>
            </ng-template>
        </p-dialog>

        <!-- Bulk Delete dialog -->
        <p-dialog [(visible)]="bulkDeleteDialog" header="Törlés" [modal]="true" [style]="{width:'450px'}">
            <div class="flex align-items-center justify-content-center">
                <i class="pi pi-exclamation-triangle mr-3" style="font-size: 2rem"></i>
                <span>Biztosan törölni akarja a kiválasztott konferenciákat?</span>
            </div>
            <ng-template pTemplate="footer">
                <div class="flex justify-content-end ap-2">
                    <button pButton pRipple label="Nem" icon="pi pi-times" class="p-button-outlined"
                        (click)="bulkDeleteDialog = false"></button>
                    <button pButton pRipple label="Igen" icon="pi pi-check" class="p-button ml-2"
                        (click)="deleteSelected()"></button>
                </div>
            </ng-template>
        </p-dialog>
    </div>
</div>

<!-- Loading Overlay -->
<p-blockUI [autoZIndex]="true" [blocked]="loading">
    <p-progressSpinner></p-progressSpinner>
</p-blockUI>

<!-- Notifications -->
<p-toast></p-toast>
<div class="grid">
    <div class="col-12">
        <div class="card px-0 py-0">
            <p-table #dt
                     dataKey="id"
                     [value]="tableData"
                     responsiveLayout="scroll"
                     [rows]="rowsPerPage"
                     [totalRecords]="totalRecords"
                     [globalFilterFields]="['roomNum']"
                     [paginator]="true"
                     [rowsPerPageOptions]="rowsPerPageOptions"
                     [showCurrentPageReport]="true"
                     currentPageReportTemplate="{first} - {last} bejegyzés a(z) {totalRecords}-ból megjelenítése"
                     [(selection)]="selected"
                     selectionMode="multiple"
                     [tableStyle]="{'min-height': 'calc(100vh - 320px)'}"
                     [rowHover]="true"
                     (onLazyLoad)="onLazyLoad($event)"
                     [lazy]="true">

                <ng-template pTemplate="caption">
                    <div class="flex flex-column md:flex-row md:justify-content-between md:align-items-center">
                        <h5 class="m-0">Foglalások</h5>
                        <span class="block mt-2 md:mt-0">
                            <app-conference-selector
                                [(ngModel)]="selectedConferences"
                                [emitOnSelectFirstOption]="true"
                                [showNoneOption]="false"
                                [selectionLimit]="1"
                                [showClear]="true"
                                [style]="{'minWidth': '35rem'}"
                                placeholder="Válasszon konferenciát..."
                                (ngModelChange)="doQuery()">
                            </app-conference-selector>
                        </span>
                        <span class="block mt-2 md:mt-0 p-input-icon-left">
                            <div class="border-round-xl w-min p-0" style="background-color: #E2E8F0;" pTooltip="Ágyak száma: {{ totalBeds }}" tooltipPosition="top">
                                <div class="flex align-items-center justify-content-center py-1 px-1">
                                    <div class="flex align-items-center justify-content-center gap-2 px-2">
                                        <svg width="24px" height="24px" viewBox="0 0 24 24" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" fill="#000000">
                                            <g id="SVGRepo_bgCarrier" stroke-width="0"/>
                                            <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"/>
                                            <g id="SVGRepo_iconCarrier">
                                                <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"> 
                                                    <g id="ic_fluent_bed_24_filled" fill="#334155" fill-rule="nonzero"> 
                                                        <path d="M19.25,11 C20.7125318,11 21.9084043,12.1417046 21.9949812,13.5824777 L22,13.75 L22,20.25 C22,20.6642136 21.6642136,21 21.25,21 C20.8703042,21 20.556509,20.7178461 20.5068466,20.3517706 L20.5,20.25 L20.5,18 L3.5,18 L3.5,20.25 C3.5,20.6296958 3.21784612,20.943491 2.85177056,20.9931534 L2.75,21 C2.37030423,21 2.05650904,20.7178461 2.00684662,20.3517706 L2,20.25 L2,13.75 C2,12.2874682 3.1417046,11.0915957 4.58247767,11.0050188 L4.75,11 L19.25,11 Z M6.75,4 L17.25,4 C18.7125318,4 19.9084043,5.1417046 19.9949812,6.58247767 L20,6.75 L20,10 L17,10 L16.9932723,9.88337887 C16.9399506,9.42429701 16.575703,9.06004937 16.1166211,9.00672773 L16,9 L14,9 C13.4871642,9 13.0644928,9.38604019 13.0067277,9.88337887 L13,10 L11,10 L10.9932723,9.88337887 C10.9399506,9.42429701 10.575703,9.06004937 10.1166211,9.00672773 L10,9 L8,9 C7.48716416,9 7.06449284,9.38604019 7.00672773,9.88337887 L7,10 L4,10 L4,6.75 C4,5.28746816 5.1417046,4.09159572 6.58247767,4.00501879 L6.75,4 Z"> 
                                                        </path> 
                                                    </g> 
                                                </g> 
                                            </g>
                                        </svg>
                                        <span class="text-2xl font-normal white-space-nowrap vertical-align-middle">
                                            {{ totalBeds }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </span>
                        <span class="block mt-2 md:mt-0 p-input-icon-left">
                            <div class="border-round-xl w-min p-0" style="background-color: #E2E8F0;" pTooltip="Regisztrált vendégek: {{ registeredGuests }}" tooltipPosition="top">
                                <div class="flex align-items-center justify-content-center py-1 px-1">
                                    <div class="flex align-items-center justify-content-center gap-2 px-2">
                                        <i class="pi pi-users" style="font-size: 1.5rem"></i>
                                        <span class="text-2xl font-normal white-space-nowrap vertical-align-middle">
                                            {{ registeredGuests }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </span>
                        <span class="block mt-2 md:mt-0 p-input-icon-left">
                            <div class="border-round-xl w-min p-0 bg-green-100" pTooltip="Vendégek foglalással: {{ reservedGuests }}" tooltipPosition="top">
                                <div class="flex align-items-center justify-content-center py-1 px-1">
                                    <div class="flex align-items-center justify-content-center gap-2 px-2">
                                        <i class="pi pi-users" style="font-size: 1.5rem"></i>
                                        <span class="text-2xl font-normal white-space-nowrap vertical-align-middle">
                                            {{ reservedGuests }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </span>
                        <span class="block mt-2 md:mt-0 p-input-icon-left">
                            <div class="border-round-xl w-min p-0 bg-yellow-100" pTooltip="Szobára várók: {{ waitingForRoom }}" tooltipPosition="top">
                                <div class="flex align-items-center justify-content-center py-1 px-1">
                                    <div class="flex align-items-center justify-content-center gap-2 px-2">
                                        <i class="pi pi-users" style="font-size: 1.5rem"></i>
                                        <span class="text-2xl font-normal white-space-nowrap vertical-align-middle">
                                            {{ waitingForRoom }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </span>
                        <span class="block mt-2 md:mt-0">
                            <button pButton pRipple label="Új" icon="pi pi-plus" class="p-button-success mr-2" (click)="create()" [disabled]="!canCreate"></button>
                            <button pButton pRipple label="Törlés" icon="pi pi-trash" class="p-button-danger mr-2" (click)="bulkDeleteDialog = true" [disabled]="!selected || !selected.length || !canDelete"></button>
                            <!-- <button pButton pRipple label="Export" icon="pi pi-download" class="p-button-help mr-2" (click)="exportExcel()"></button> -->
                        </span>
                    </div>
                </ng-template>
                <ng-template pTemplate="header">
                    <tr>
                        <th></th>
                        <th pSortableColumn="roomNum">Szoba <p-sortIcon field="roomNum"></p-sortIcon></th>
                        <th>Vendégek</th>
                        <th pSortableColumn="startDate">Érkezés <p-sortIcon field="startDate"></p-sortIcon></th>
                        <th pSortableColumn="endDate">Távozás <p-sortIcon field="endDate"></p-sortIcon></th>
                        <th pSortableColumn="status">Státusz <p-sortIcon field="status"></p-sortIcon></th>
                        <th pSortableColumn="notes">Megjegyzés <p-sortIcon field="notes"></p-sortIcon></th>
                        <th></th>
                    </tr>
                    <tr>
                        <th styleClass="w-3rem">
                            <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                        </th>
                        <th>
                            <input pInputText
                                   type="text"
                                   class="mr-2"
                                   (input)="onFilter($event, 'room.roomNum')"
                                   placeholder="Szobaszám..."
                                   style="width:8rem"/>
                           <app-building-selector
                                   class="mr-2"
                                   (change)="onFilter($event, 'room.building')"
                                   [showClear]="true"
                                   placeholder="Épület...">
                           </app-building-selector>
                           <app-bedtype-selector
                                   (change)="onFilter($event, 'room.bedType')"
                                   [showClear]="true"
                                   placeholder="Ágytipus...">
                           </app-bedtype-selector>
                        </th>
                        <th>
                            <input pInputText
                                   type="text"
                                   (input)="onFilter($event, 'guests')"
                                   placeholder="Vendég..."
                                   style="width: 10rem"/>
                        </th>
                        <th>
                            <p-calendar
                                (onSelect)="onFilter($event, 'startDate')"
                                (onClearClick)="onFilter($event, 'startDate')"
                                appendTo="body"
                                dataType="string"
                                placeholder="Keresés..."
                                [showButtonBar]="true"
                                inputStyleClass="w-6rem">
                            </p-calendar>
                        </th>
                        <th>
                            <p-calendar
                                (onSelect)="onFilter($event, 'endDate')"
                                (onClearClick)="onFilter($event, 'endDate')"
                                appendTo="body"
                                dataType="string"
                                placeholder="Keresés..."
                                [showButtonBar]="true"
                                inputStyleClass="w-6rem">
                            </p-calendar>
                        </th>
                        <th>
                            <app-reservation-status-selector
                                   (change)="onFilter($event, 'status')"
                                   [showClear]="true"
                                   placeholder="Státusz...">
                            </app-reservation-status-selector>
                        </th>
                        <th>
                            <input pInputText
                                   type="text"
                                   (input)="onFilter($event, 'notes')"
                                   placeholder="Keresés..."
                                   style="width:8rem"/>
                        </th>
                        <th></th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-reservation>
                    <tr>
                        <td>
                            <p-tableCheckbox [value]="reservation"></p-tableCheckbox>
                        </td>
                        <td>
                            <span class="p-column-title">Szoba</span>

                            <div class="flex align-items-center gap-2">
                                <!-- Szoba badge -->
                                <div class="building-badge {{reservation.room.building}} border-round-xl w-min p-0">
                                    <div class="flex align-items-center justify-content-center py-1 px-1">
                                        <div class="flex align-items-center justify-content-center gap-2 px-2">
                                            <i class="pi pi-key vertical-align-middle"></i>
                                            <span class="text-2xl font-semibold white-space-nowrap vertical-align-middle" pTooltip="Szoba szám: {{ reservation.room.roomNum }}" tooltipPosition="top">
                                                {{ reservation.room.roomNum }}
                                            </span>
                                        </div>
                                        <div class="block min-w-max border-left-1 px-2" pTooltip="Szoba kód: {{ reservation.room.roomCode }}" tooltipPosition="top">
                                            <div class="flex flex-column align-items-left justify-content-center">
                                                <span class="text-base font-semibold uppercase">
                                                    {{ 'BUILDINGS.' + reservation.room.building.toUpperCase() | translate }} <span *ngIf="reservation.room.floor" class="font-normal text-sm uppercase">({{ reservation.room.floor }})</span>
                                                    <span *ngIf="reservation.room.climate" class="pl-1">❄️</span>
                                                </span>
                                                <span class="font-light text-xs uppercase">
                                                    {{ reservation.room.beds }} SZEMÉLYES ({{ reservation.room.bedType }}<span *ngIf="reservation.room.bathroom">, {{ reservation.room.bathroom }}</span>)
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Babybed indicator – 0–3 years old guests need baby bed -->
                                <ng-container *ngIf="getBabyBedGuests(reservation) as babyGuests">
                                    <div *ngIf="babyGuests.length > 0"
                                        class="border-round-xl w-min p-0 bg-purple-100">
                                        <div class="flex align-items-center justify-content-center py-1 px-1">
                                            <div class="flex align-items-center justify-content-center gap-1 px-2">
                                                <!-- Exactly one baby: show a single icon with direct tooltip -->
                                                <ng-container *ngIf="babyGuests.length === 1; else multipleBabyBeds">
                                                    <img src="/assets/demo/images/baby-bed.svg"
                                                        alt="Baby bed"
                                                        style="max-width: 20px;"
                                                        pTooltip="{{ babyGuests[0].lastName }} {{ babyGuests[0].firstName }} ({{ getAge(babyGuests[0].birthDate) }})"
                                                        tooltipPosition="top">
                                                </ng-container>

                                                <!-- More than one baby: one icon + count -->
                                                <ng-template #multipleBabyBeds>
                                                    <img src="/assets/demo/images/baby-bed.svg"
                                                        alt="Baby bed"
                                                        style="max-width: 20px;"
                                                        pTooltip="{{ getBabyBedTooltip(babyGuests) }}"
                                                        tooltipPosition="top">
                                                    <span class="text-sm font-semibold pl-1">
                                                        {{ babyGuests.length }}
                                                    </span>
                                                </ng-template>
                                            </div>
                                        </div>
                                    </div>
                                </ng-container>
                            </div>
                        </td>
                        <td>
                            <span class="p-column-title">Vendégek</span>
                            <p-avatarGroup >
                                <p-avatar *ngFor="let guest of reservation.guests" 
                                           icon="pi pi-user" 
                                           size="large" 
                                           shape="circle"
                                           pTooltip="{{guest.lastName + ' ' + guest.firstName}} ({{getAge(guest.birthDate)}})" 
                                           tooltipPosition="top">
                                </p-avatar>
                                <!-- Capacity badge: hidden when 0, green if >0, red if <0 -->
                                <p-avatar
                                    *ngIf="getFreeCapacity(reservation) as cap"
                                    [label]="formatCapacityLabel(cap)"
                                    shape="circle"
                                    size="large"
                                    [style]="capacityStyle(cap)"
                                    pTooltip="{{ capacityTooltip(cap) }}"
                                    tooltipPosition="top">
                                </p-avatar>
                            </p-avatarGroup>
                        </td>
                        <td style="max-width: 300px;">
                            <span class="p-column-title">Érkezés</span>
                            <span class="calendar-badge">
                                <i class="pi pi-calendar mr-1"></i>
                                {{ reservation.startDate | date:'yyyy.MM.dd' }}
                            </span>
                        </td>
                        <td style="max-width: 300px;">
                            <span class="p-column-title">Távozás</span>
                            <span class="calendar-badge">
                                <i class="pi pi-calendar mr-1"></i>
                                {{ reservation.endDate | date:'yyyy.MM.dd' }}
                            </span>
                        </td>
                        <td style="max-width: 300px;">
                            <span class="p-column-title">Státusz</span>
                            <span *ngIf="reservation.status" class="reservation-status-badge {{ reservation.status }}">
                                {{ 'RESERVATION_STATUSES.' + reservation.status?.toUpperCase() | translate }}
                            </span>
                        </td>
                        <td>
                            <span class="p-column-title">Megjegyzés</span>
                            {{ reservation.notes }}
                        </td>
                        <td>
                            <div class="flex">
                                <button pButton pRipple icon="pi pi-pencil" class="p-button-rounded p-button-success mr-2" (click)="edit(reservation)" [disabled]="!canEdit"></button>
                                <button pButton pRipple icon="pi pi-trash" class="p-button-rounded p-button-warning" (click)="tableItem = reservation; deleteDialog = true" [disabled]="!canDelete"></button>
                            </div>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td [attr.colspan]="8" class="text-center">Nincs találat...</td>
                    </tr>
                </ng-template>
            </p-table>
        </div>

        <!-- New / Update sidebar -->
        <p-sidebar 
            id="sidebar" 
            [(visible)]="sidebar" 
            position="right" 
            styleClass="p-sidebar-md"
            [transitionOptions]="'.3s cubic-bezier(0, 0, 0.2, 1)'" 
            [fullScreen]="isMobile"
            [blockScroll]="true"
            (onHide)="onSidebarHide()"
            (onShow)="onSidebarShow()">

            <!-- Sidebar header -->
            <ng-template pTemplate="header">
                <span class="font-semibold text-xl">
                    {{ id?.value ? 'Foglalás adatai' : 'Új foglalás' }}
                </span>
            </ng-template>

            <!-- Render content only after first open -->
            <ng-container *ngIf="sidebar">
                <form [formGroup]="reservationForm" (ngSubmit)="save()" novalidate class="grid formgrid p-fluid">
                    
                    <!-- Reservation Id -->
                    <input formControlName="id" type="hidden">
                    <input formControlName="conference_id" type="hidden">
                    <input formControlName="room_id" type="hidden">
                    <input formControlName="guestIds" type="hidden">

                    <!-- Conference -->
                    <div class="field mb-4 col-12">
                        <label for="conference" class="font-medium text-900">Konferencia</label>
                        <app-conference-selector
                            formControlName="conference"
                            [preselectIds]="preselectConferenceId"
                            [showNoneOption]="false"
                            [selectionLimit]="1"
                            [showClear]="true"
                            placeholder="Válasszon konferenciát...">
                        </app-conference-selector>
                        <div *ngIf="conference?.dirty && conference?.errors?.['required']" class="block p-error">
                            Kötelező kitölteni
                        </div>
                    </div>

                    <!-- Guests -->
                    <div class="field mb-4 col-12">
                        <label for="guest" class="font-medium text-900">Vendég</label>
                        <app-guest-selector
                            formControlName="guests"
                            [filter]="guestFilter"
                            [preselectIds]="preselectGuestIds"
                            [emitOnPreselectId]="true"
                            [showOnlyNotReserved]="true"
                            [groupByRoomMate]="true"
                            [showClear]="true"
                            placeholder="Vendég...">
                        </app-guest-selector>
                        <div *ngIf="guests?.dirty && guests?.errors?.['required']" class="block p-error">
                            Kötelező kitölteni
                        </div>
                    </div>

                    <!-- Room -->
                    <div class="field mb-4 col-12">
                        <label for="room_id" class="font-medium text-900">Szoba</label>
                        <app-room-selector
                            formControlName="room"
                            [filter]="roomFilter"
                            [selectionLimit]="1"
                            [preselectIds]="preselectRoomIds"
                            [emitOnPreselectId]="true"
                            [showOnlyNotReserved]="true"
                            [showClear]="true"
                            placeholder="Szoba...">
                        </app-room-selector>
                        <div *ngIf="room?.dirty && room?.errors?.['required']" class="block p-error">
                            Kötelező kitölteni
                        </div>
                    </div>

                    <!-- startDate -->
                    <div class="field mb-4 col-6">
                        <label for="startDate" class="font-medium text-900">
                            {{'Érkezés dátuma' | translate }}
                        </label>
                        <p-calendar id="startDate"
                                    formControlName="startDate"
                                    [ngClass]="{'ng-invalid': reservationForm.errors?.['dateRangeInvalid']}"
                                    dateFormat="yy-mm-dd"
                                    dataType="string"
                                    appendTo="body">
                        </p-calendar>
                        <div *ngIf="startDate?.dirty && startDate?.errors?.['required']" class="p-error">
                            {{'Kérjük, adja meg az érkezés dátumát' | translate }}!
                        </div>
                        <div *ngIf="reservationForm.errors?.['dateRangeInvalid']" class="p-error">
                            {{'Az érkezés dátumának korábbinak kell lennie, mint a távozási dátum' | translate }}!
                        </div>
                    </div>

                    <!-- endDate -->
                    <div class="field mb-4 col-6">
                        <label for="endDate" class="font-medium text-900">
                            {{'Távozás dátuma' | translate }}
                        </label>
                        <p-calendar id="endDate"
                                    formControlName="endDate"
                                    [ngClass]="{'ng-invalid': reservationForm.errors?.['dateRangeInvalid']}"
                                    dateFormat="yy-mm-dd"
                                    dataType="string"
                                    appendTo="body">
                        </p-calendar>
                        <div *ngIf="endDate?.dirty && endDate?.errors?.['required']" class="p-error">
                            {{'Kérjük, adja meg az érkezés dátumát' | translate }}!
                        </div>
                        <div *ngIf="reservationForm.errors?.['dateRangeInvalid']" class="p-error">
                            {{'Az érkezés dátumának korábbinak kell lennie, mint a távozási dátum' | translate }}!
                        </div>
                    </div>

                    <!-- Status -->
                    <div class="field mb-4 col-12">
                        <label for="status" class="font-medium text-900">Státusz</label>
                        <app-reservation-status-selector
                                formControlName="status"
                                [showClear]="true"
                                placeholder="Státusz...">
                        </app-reservation-status-selector>
                        <div *ngIf="status?.dirty && status?.errors?.['required']" class="block p-error">
                            Kötelező kitölteni
                        </div>
                    </div>

                    <!-- notes -->
                    <div class="field mb-4 col-12">
                        <label for="notes" class="font-medium text-900">Megjegyzés</label>
                        <textarea id="notes" type="text" formControlName="notes" pInputTextarea rows="5"></textarea>
                        <div *ngIf="notes?.dirty && notes?.errors?.['required']" class="block p-error">
                            Kötelező kitölteni
                        </div>
                    </div>
                </form>
            </ng-container>

            <ng-template pTemplate="footer">
                <div class="flex justify-content-end ap-2">
                    <button pButton 
                            pRipple 
                            label="Mégsem" 
                            icon="pi pi-times" 
                            class="p-button-outlined"
                            (click)="cancel()" 
                            [disabled]="!reservationForm.dirty">
                    </button>
                    <button pButton 
                            pRipple 
                            label="Mentés" 
                            icon="pi pi-check" 
                            class="p-button ml-2" 
                            (click)="save()"
                            [disabled]="!reservationForm.valid || !reservationForm.dirty">
                    </button>
                </div>
            </ng-template>
        </p-sidebar>

        <!-- Delete dialog -->
        <p-dialog [(visible)]="deleteDialog" header="Törlés" [modal]="true" [style]="{width:'450px'}">
            <div class="flex align-items-center justify-content-center">
                <i class="pi pi-exclamation-triangle mr-3" style="font-size: 2rem"></i>
                <span *ngIf="tableItem">Biztosan törölni akarja a(z) <b>{{tableItem.room?.roomNum}}</b> szoba foglalását?</span>
            </div>
            <ng-template pTemplate="footer">
                <button pButton pRipple label="Nem" icon="pi pi-times" class="p-button-outlined" (click)="deleteDialog = false"></button>
                <button pButton pRipple label="Igen" icon="pi pi-check" class="p-button ml-2" (click)="delete()"></button>
            </ng-template>
        </p-dialog>

        <!-- Bulk Delete dialog -->
        <p-dialog [(visible)]="bulkDeleteDialog" header="Törlés" [modal]="true" [style]="{width:'450px'}">
            <div class="flex align-items-center justify-content-center">
                <i class="pi pi-exclamation-triangle mr-3" style="font-size: 2rem"></i>
                <span>Biztosan törölni akarja a kiválasztott foglalásokat?</span>
            </div>
            <ng-template pTemplate="footer">
                <button pButton pRipple label="Nem" icon="pi pi-times" class="p-button-outlined" (click)="bulkDeleteDialog = false"></button>
                <button pButton pRipple label="Igen" icon="pi pi-check" class="p-button ml-2" (click)="deleteSelected()"></button>
            </ng-template>
        </p-dialog>
    </div>
</div>

<!-- Loading Overlay -->
<p-blockUI [autoZIndex]="true" [blocked]="loading">
    <p-progressSpinner></p-progressSpinner>
</p-blockUI>

<!-- Notifications -->
<p-toast></p-toast>

<!-- Confirm Dialog -->
<p-confirmDialog [closable]="false" [style]="{ width: '28rem' }"></p-confirmDialog>

